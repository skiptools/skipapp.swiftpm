name: Skip App CI

env:
  DEVELOPER_DIR: /Applications/Xcode_14.3.app/Contents/Developer

on:
  push:
    branches: '*'
  schedule:
    - cron:  '0 1,7,13,23 * * *'

jobs:
  skip-template-tests:
    runs-on: macos-13
    steps:
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check skiptool
        run: swift package --disable-sandbox --allow-writing-to-package-directory skip info

      - name: Prepare Artifacts
        run: |
          mkdir -p .build/skip-artifacts/
          brew install tree

      - name: Build AppDemoKt (SPM)
        run: swift build --jobs 1

      - name: Test AppDemoKt (SPM)
        run: swift test --jobs 1

      - name: Copy Android Artifacts
        run: |
          tree -I build -l .build/plugins/outputs
          cp -a .build/plugins/outputs/skipapp.swiftpm/AppDemoKtTests/skip-transpiler/AppDemo/.build/AppDemo/outputs/apk/release/AppDemo-release-unsigned.apk .build/skip-artifacts/App-Android-Release.apk
          cp -a .build/plugins/outputs/skipapp.swiftpm/AppDemoKtTests/skip-transpiler/AppDemo/.build/AppDemo/outputs/apk/debug/AppDemo-debug.apk .build/skip-artifacts/App-Android-Debug.apk

          cd .build/skip-artifacts/

          ls -lah

          ARTIFACTNAME="App-Android-Debug.apk"
          ls -la "${ARTIFACTNAME}"
          shasum -a 256 "${ARTIFACTNAME}" | tee "${ARTIFACTNAME}.sha256"
          cat "${ARTIFACTNAME}.sha256" >> releasenotes.txt

          ARTIFACTNAME="App-Android-Release.apk"
          ls -la "${ARTIFACTNAME}"
          shasum -a 256 "${ARTIFACTNAME}" | tee "${ARTIFACTNAME}.sha256"
          cat "${ARTIFACTNAME}.sha256" >> releasenotes.txt

      - name: Test AppDemoKt (Xcode)
        if: false
        run: xcodebuild test -skipPackagePluginValidation -configuration Debug -sdk "macosx" -destination "platform=macosx" -scheme "AppDemoKt"

      - name: Package iOS App
        run: |
          # the function to run to create different archive variants
          build_archive() {
            APPARTIFACT="${APPNAME}-${APPPLATFORM}-${APPCONFIG}"
            COMMITDATE="$(git log -1 --format=%ad --date=iso-strict ${GITHUB_REF#refs/tags/})"

            xcodebuild archive -jobs 1 -skipPackagePluginValidation -archivePath ".build/${APPARTIFACT}.xcarchive" -configuration "${APPCONFIG}" -scheme 'Demo App' -sdk "${APPSDK}" -destination "generic/platform=${APPPLATFORM}" CODE_SIGNING_ALLOWED=NO || echo "archive failed"

            cd .build/"${APPARTIFACT}".xcarchive/Products/

            mv "Applications" "Payload"
            tree -h .

            # create the zip file with predictable timestamps
            find "Payload" -exec touch -d "${COMMITDATE:0:19}" {} \;
            ditto -c -k --sequesterRsrc --keepParent "Payload" ../../skip-artifacts/"${APPARTIFACT}.ipa"
            cd -

            cd .build/skip-artifacts/
            ls -la "${APPARTIFACT}.ipa"
            shasum -a 256 "${APPARTIFACT}.ipa" | tee "${APPARTIFACT}.ipa.sha256"
            cat "${APPARTIFACT}.ipa.sha256" >> releasenotes.txt
            cd -
          }

          APPNAME="App"
          APPPLATFORM="iOS"
          APPSDK="iphoneos"

          APPCONFIG="Debug" build_archive
          APPCONFIG="Release" build_archive

      - name: Show PlugIn Output Tree (Xcode)
        run: |
          #tree -I build -l ~/Library/Developer/Xcode/DerivedData/*/SourcePackages/plugins/skipapp.swiftpm.output/AppDemoKt
          tree -I build -l ~/Library/Developer/Xcode/DerivedData/*/SourcePackages/plugins/

      - name: "Upload Build Artifacts"
        # upload the artifacts generated from each build
        uses: actions/upload-artifact@v3
        if: always()
        with: 
          path: .build/skip-artifacts/

